<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Загрузка изображений</title>
</head>
<body>
    <h1>Выберите изображения:</h1>
    <input type="file" id="images" multiple accept="image/*">
    <button onclick="uploadImages()">Отправить</button>
    
    <!-- Подключаем jQuery для упрощения работы с AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@1.0.12/dist/browser-image-compression.js"></script>
    <script>
        function uploadImages() {
            const files = document.getElementById('images').files;
            if (!files.length) return alert('Пожалуйста, выберите хотя бы одно изображение.');
            
            // Сжимаем и отправляем каждое изображение
            for (let i = 0; i < files.length; i++) {
				sendToServer(compressAndEncodeImage(files[i]), file.name);
            }
        }
        
		async function compressAndEncodeImage(file) {
			try {
				const options = {
					maxSizeMB: 1, // Максимальный размер файла после сжатия (в мегабайтах)
					maxWidthOrHeight: 1920, // Максимальная ширина или высота изображения
					useWebWorker: true // Использовать Web Worker для параллельной обработки
				};
				
				const compressedFile = await imageCompression(file, options);
				return await toBase64(compressedFile);
			} catch (error) {
				console.error('Error compressing or encoding the image:', error);
			}
		}

		// Функция для преобразования Blob в Base64
		function toBase64(blob) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onloadend = () => resolve(reader.result);
				reader.onerror = reject;
				reader.readAsDataURL(blob);
			});
		}
		
        function compressAndSend(file) {
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const img = await resizeImage(event.target.result);
                    sendToServer(img, file.name);
                } catch (error) {
                    console.error(error);
                }
            };
            reader.readAsDataURL(file);
        }
        
        function resizeImage(imageSrc) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = imageSrc;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Определяем максимальный размер изображения
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 1024;
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // Качество сжатия 70%
                };
                img.onerror = reject;
            });
        }
        
        function sendToServer(base64Image, filename) {
            $.ajax({
                url: 'https://script.google.com/macros/s/AKfycbwRXVLd8j-F-X9PC6EXNaHMAKcElipLBgPz1poNd5LDmk65z4W3oGSKa-o1f2Io4MTIcw/exec',
                method: 'POST',
                data: { image: base64Image, name: filename },
                success: function(response) {
                    alert('Успешная загрузка:', response);
                },
                error: function(xhr, status, error) {
                    alert('Ошибка загрузки:', xhr.statusText);
                }
            });
        }
    </script>
</body>
</html>